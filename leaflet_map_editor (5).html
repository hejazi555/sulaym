<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø±Ø§Ø¦Ø·</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            width: 380px;
            background: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-header {
            padding: 15px;
            background: #4CAF50;
            color: white;
        }
        .sidebar-header h1 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 15px;
            background: white;
            color: #4CAF50;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
        }
        button:hover {
            background: #f0f0f0;
        }
        button.danger {
            background: #f44336;
            color: white;
        }
        button.danger:hover {
            background: #da190b;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-size: 14px;
        }
        .tab:hover {
            background: #e8e8e8;
        }
        .tab.active {
            background: white;
            border-bottom-color: #4CAF50;
            font-weight: bold;
        }
        
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        
        .area-item, .helper-item, .shp-item {
            background: #f9f9f9;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        .area-item.selected, .helper-item.selected {
            border-color: #FF5722;
            background: #fff3e0;
        }
        .area-header, .helper-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .area-title {
            font-weight: bold;
            color: #333;
        }
        .area-actions {
            display: flex;
            gap: 5px;
        }
        .area-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }
        .coords {
            font-size: 11px;
            color: #666;
            background: white;
            padding: 8px;
            border-radius: 3px;
            max-height: 100px;
            overflow-y: auto;
            margin-top: 5px;
        }
        .coords div {
            margin: 2px 0;
        }
        
        .helper-item {
            background: #fff3cd;
            border-color: #ffc107;
        }
        .helper-info {
            font-size: 12px;
            flex: 1;
        }
        .helper-coords {
            color: #856404;
            font-weight: bold;
        }
        
        .shp-item {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        .shp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .shp-info {
            font-size: 12px;
            flex: 1;
        }
        .shp-name {
            color: #2E7D32;
            font-weight: bold;
        }
        .shp-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #c8e6c9;
        }
        .shp-control-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }
        .shp-control-row label {
            font-size: 11px;
            color: #666;
            min-width: 40px;
        }
        .shp-control-row input[type="color"] {
            width: 50px;
            height: 30px;
            border: 1px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
        }
        .shp-control-row input[type="range"] {
            flex: 1;
        }
        .shp-control-row input[type="number"] {
            width: 60px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .add-helper-form, .upload-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .add-helper-form h3, .upload-section h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }
        .form-group {
            margin-bottom: 10px;
        }
        .form-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            color: #666;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .form-actions {
            display: flex;
            gap: 8px;
        }
        .form-actions button {
            flex: 1;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .file-input-button {
            display: block;
            padding: 10px;
            background: #2196F3;
            color: white;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
        }
        .file-input-button:hover {
            background: #1976D2;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-switcher {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .map-switcher h4 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #333;
        }
        .map-switcher label {
            display: block;
            padding: 6px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 3px;
            margin-bottom: 3px;
        }
        .map-switcher label:hover {
            background: #f0f0f0;
        }
        .map-switcher input[type="radio"] {
            margin-left: 8px;
        }
        
        .drawing-tools {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .drawing-tools button {
            display: block;
            width: 100%;
            margin-bottom: 5px;
            background: #4CAF50;
            color: white;
        }
        .drawing-tools button:hover {
            background: #45a049;
        }
        .drawing-tools button.active {
            background: #2196F3;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .info-box {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #1976d2;
        }
        
        .leaflet-marker-icon {
            cursor: move !important;
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: 50%;
                border-left: none;
                border-top: 1px solid #ddd;
            }
            .map-container {
                height: 50%;
            }
        }
    </style>
</head>
<body>
    <div class="map-container">
        <div id="map"></div>
        
        <div class="map-switcher">
            <h4>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h4>
            <label>
                <input type="radio" name="maptype" value="google-satellite" checked>
                Google Satellite
            </label>
            <label>
                <input type="radio" name="maptype" value="esri-satellite">
                ESRI Satellite
            </label>
            <label>
                <input type="radio" name="maptype" value="mapbox-satellite">
                Mapbox Satellite
            </label>
            <label>
                <input type="radio" name="maptype" value="osm-standard">
                OpenStreetMap
            </label>
        </div>
        
        <div class="drawing-tools">
            <button id="drawPolygon">ğŸ”· Ø±Ø³Ù… Ù…Ù†Ø·Ù‚Ø©</button>
            <button id="addHelper">ğŸ“ Ù†Ù‚Ø·Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©</button>
            <button id="stopDrawing">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
        </div>
    </div>
    
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø±Ø§Ø¦Ø·</h1>
            <div class="controls">
                <button onclick="saveGeoJSON()">ğŸ’¾ Ø­ÙØ¸ GeoJSON</button>
                <button class="danger" onclick="clearAll()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('areas')">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div>
            <div class="tab" onclick="switchTab('helpers')">Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</div>
            <div class="tab" onclick="switchTab('shp')">Ù…Ù„ÙØ§Øª SHP</div>
        </div>
        
        <div class="tab-content">
            <div id="areas-panel" class="tab-panel active">
                <div class="info-box">
                    ğŸ’¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ù…ÙØ±ØºØ© Ù…Ø¹ Ø­Ø¯ÙˆØ¯ ÙˆØ§Ø¶Ø­Ø©<br>
                    ğŸ–±ï¸ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù†Ù‚Ø·Ø© + Q Ù„Ø­Ø°ÙÙ‡Ø§ | Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù†Ù‚Ø·Ø© ÙˆØ§Ø³Ø­Ø¨Ù‡Ø§ Ù„ØªØ­Ø±ÙŠÙƒÙ‡Ø§<br>
                    âœï¸ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø­Ø§ÙØ© Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </div>
                <div id="areasList"></div>
            </div>
            <div id="helpers-panel" class="tab-panel">
                <div class="add-helper-form">
                    <h3>Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©</h3>
                    <div class="form-group">
                        <label>Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶ (Latitude)</label>
                        <input type="number" id="helperLat" step="any" placeholder="24.7136">
                    </div>
                    <div class="form-group">
                        <label>Ø®Ø· Ø§Ù„Ø·ÙˆÙ„ (Longitude)</label>
                        <input type="number" id="helperLng" step="any" placeholder="46.6753">
                    </div>
                    <div class="form-actions">
                        <button onclick="addHelperByCoords()">â• Ø¥Ø¶Ø§ÙØ©</button>
                        <button onclick="clearHelperForm()">ğŸ”„ Ù…Ø³Ø­</button>
                    </div>
                </div>
                <div class="info-box">
                    ğŸ’¡ Ø§Ø³Ø­Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØµÙØ±Ø§Ø¡ Ù„ØªØ­Ø±ÙŠÙƒÙ‡Ø§. Ø§Ø¶ØºØ· Q Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                </div>
                <div id="helpersList"></div>
            </div>
            <div id="shp-panel" class="tab-panel">
                <div class="upload-section">
                    <h3>Ø±ÙØ¹ Ù…Ù„ÙØ§Øª SHP Ù…Ø³Ø§Ø¹Ø¯Ø©</h3>
                    <div class="file-input-wrapper">
                        <label class="file-input-button">
                            ğŸ“ Ø§Ø®ØªØ± Ù…Ù„Ù ZIP (ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ SHP)
                            <input type="file" id="shpFileInput" accept=".zip" onchange="handleShpUpload(event)">
                        </label>
                    </div>
                </div>
                <div class="info-box">
                    ğŸ’¡ Ø§Ø±ÙØ¹ Ù…Ù„Ù ZIP ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ .shp Ùˆ .shx Ùˆ .dbf<br>
                    Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙ‚Ø· ÙˆÙ„Ø§ ØªÙØ­ÙØ¸ ÙÙŠ GeoJSON
                </div>
                <div id="shpList"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shpjs/4.0.4/shp.min.js"></script>
    <script>
        let map;
        let currentLayer;
        let areas = [];
        let helperMarkers = [];
        let shpLayers = [];
        let currentDrawingMode = null;
        let drawingPolygon = null;
        let tempMarkers = [];
        let selectedArea = null;
        let selectedHelper = null;
        let selectedMarker = null;
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage
        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('mapEditorData');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
                    if (data.areas) {
                        data.areas.forEach(areaData => {
                            const latlngs = areaData.coords.map(c => L.latLng(c.lat, c.lng));
                            const polygon = L.polygon(latlngs, {
                                fillColor: 'transparent',
                                fillOpacity: 0,
                                color: '#2E7D32',
                                weight: 3
                            }).addTo(map);
                            
                            const markers = [];
                            latlngs.forEach((latlng, index) => {
                                const marker = createEditMarker(latlng, polygon, index, markers);
                                markers.push(marker);
                            });
                            
                            const area = {
                                id: areaData.id || 'area_' + Date.now(),
                                polygon: polygon,
                                markers: markers
                            };
                            areas.push(area);
                            
                            polygon.on('click', function(e) {
                                if (currentDrawingMode === null) {
                                    addPointToPolygon(polygon, e.latlng, markers);
                                    selectArea(area.id);
                                }
                            });
                        });
                    }
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
                    if (data.helpers) {
                        data.helpers.forEach(helperData => {
                            const latlng = L.latLng(helperData.lat, helperData.lng);
                            addHelperMarker(latlng);
                        });
                    }
                    
                    updateAreasList();
                    updateHelpersList();
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ LocalStorage
        function saveToStorage() {
            try {
                const data = {
                    areas: areas.map(area => ({
                        id: area.id,
                        coords: area.polygon.getLatLngs()[0].map(c => ({
                            lat: c.lat,
                            lng: c.lng
                        }))
                    })),
                    helpers: helperMarkers.map(h => ({
                        lat: h.latlng.lat,
                        lng: h.latlng.lng
                    }))
                };
                localStorage.setItem('mapEditorData', JSON.stringify(data));
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }
        }
        
        const mapLayers = {
            'google-satellite': L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: 'Google',
                maxZoom: 20
            }),
            'esri-satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'ESRI',
                maxZoom: 19
            }),
            'mapbox-satellite': L.tileLayer('https://api.mapbox.com/v4/mapbox.satellite/{z}/{x}/{y}.jpg?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                attribution: 'Mapbox',
                maxZoom: 19
            }),
            'osm-standard': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap',
                maxZoom: 19
            })
        };
        
        function initMap() {
            map = L.map('map').setView([24.7136, 46.6753], 6);
            currentLayer = mapLayers['google-satellite'].addTo(map);
            
            document.querySelectorAll('input[name="maptype"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (currentLayer) {
                        map.removeLayer(currentLayer);
                    }
                    currentLayer = mapLayers[this.value].addTo(map);
                });
            });
            
            map.on('click', function(e) {
                if (currentDrawingMode === 'polygon') {
                    addPolygonPoint(e.latlng);
                } else if (currentDrawingMode === 'helper') {
                    addHelperMarker(e.latlng);
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'q' || e.key === 'Q') {
                    if (selectedMarker !== null) {
                        deleteSelectedMarker();
                    } else if (selectedArea !== null) {
                        deleteArea(selectedArea);
                    } else if (selectedHelper !== null) {
                        deleteHelper(selectedHelper);
                    }
                }
            });
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            loadFromStorage();
        }
        
        function addPolygonPoint(latlng) {
            const marker = L.marker(latlng, {
                draggable: true,
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"><circle cx="6" cy="6" r="5" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/></svg>'),
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                })
            }).addTo(map);
            
            const markerIndex = tempMarkers.length;
            tempMarkers.push({marker: marker, latlng: latlng});
            
            marker.on('drag', function(e) {
                const newLatLng = e.target.getLatLng();
                tempMarkers[markerIndex].latlng = newLatLng;
                if (drawingPolygon) {
                    drawingPolygon.setLatLngs(tempMarkers.map(m => m.latlng));
                }
            });
            
            if (tempMarkers.length > 1) {
                if (!drawingPolygon) {
                    const latlngs = tempMarkers.map(m => m.latlng);
                    drawingPolygon = L.polygon(latlngs, {
                        fillColor: '#4CAF50',
                        fillOpacity: 0.4,
                        color: '#2E7D32',
                        weight: 2
                    }).addTo(map);
                } else {
                    drawingPolygon.setLatLngs(tempMarkers.map(m => m.latlng));
                }
            }
        }
        
        function finishPolygon() {
            if (tempMarkers.length < 3) {
                alert('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© 3 Ù†Ù‚Ø§Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            const latlngs = tempMarkers.map(m => m.latlng);
            const polygon = L.polygon(latlngs, {
                fillColor: 'transparent',
                fillOpacity: 0,
                color: '#2E7D32',
                weight: 3
            }).addTo(map);
            
            if (drawingPolygon) map.removeLayer(drawingPolygon);
            drawingPolygon = null;
            
            addArea(polygon, tempMarkers.map(m => m.marker));
            tempMarkers = [];
            stopDrawing();
            saveToStorage();
        }
        
        function createEditMarker(latlng, polygon, index, allMarkers) {
            const marker = L.marker(latlng, {
                draggable: true,
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"><circle cx="6" cy="6" r="5" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/></svg>'),
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                })
            }).addTo(map);
            
            marker.on('click', function(e) {
                L.DomEvent.stopPropagation(e);
                selectedMarker = { marker, polygon, index, allMarkers };
                highlightMarker(marker);
            });
            
            marker.on('drag', function(e) {
                const newLatLng = e.target.getLatLng();
                const currentLatlngs = polygon.getLatLngs()[0];
                currentLatlngs[index] = newLatLng;
                polygon.setLatLngs(currentLatlngs);
                updateAreasList();
                saveToStorage();
            });
            
            return marker;
        }
        
        function addPointToPolygon(polygon, latlng, markers) {
            const latlngs = polygon.getLatLngs()[0];
            
            // Ø¥ÙŠØ¬Ø§Ø¯ Ø£Ù‚Ø±Ø¨ Ø­Ø§ÙØ©
            let minDist = Infinity;
            let insertIndex = 0;
            
            for (let i = 0; i < latlngs.length; i++) {
                const p1 = latlngs[i];
                const p2 = latlngs[(i + 1) % latlngs.length];
                const dist = L.LineUtil.pointToSegmentDistance(
                    map.latLngToLayerPoint(latlng),
                    map.latLngToLayerPoint(p1),
                    map.latLngToLayerPoint(p2)
                );
                
                if (dist < minDist) {
                    minDist = dist;
                    insertIndex = i + 1;
                }
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø·Ø©
            latlngs.splice(insertIndex, 0, latlng);
            polygon.setLatLngs(latlngs);
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
            const newMarker = createEditMarker(latlng, polygon, insertIndex, markers);
            markers.splice(insertIndex, 0, newMarker);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø§Ø±Ø³
            markers.forEach((m, i) => {
                m.off('drag');
                m.off('click');
                
                m.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    selectedMarker = { marker: m, polygon, index: i, allMarkers: markers };
                    highlightMarker(m);
                });
                
                m.on('drag', function(e) {
                    const newLatLng = e.target.getLatLng();
                    const currentLatlngs = polygon.getLatLngs()[0];
                    currentLatlngs[i] = newLatLng;
                    polygon.setLatLngs(currentLatlngs);
                    updateAreasList();
                    saveToStorage();
                });
            });
            
            updateAreasList();
            saveToStorage();
        }
        
        function highlightMarker(marker) {
            marker.setIcon(L.icon({
                iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"><circle cx="6" cy="6" r="5" fill="#FF5722" stroke="#D32F2F" stroke-width="2"/></svg>'),
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            }));
        }
        
        function deleteSelectedMarker() {
            if (!selectedMarker) return;
            
            const { marker, polygon, index, allMarkers } = selectedMarker;
            
            if (allMarkers.length <= 3) {
                alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù†Ù‚Ø·Ø© - ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ 3 Ù†Ù‚Ø§Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            map.removeLayer(marker);
            allMarkers.splice(index, 1);
            
            const latlngs = polygon.getLatLngs()[0];
            latlngs.splice(index, 1);
            polygon.setLatLngs(latlngs);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø§Ø±Ø³
            allMarkers.forEach((m, i) => {
                m.off('drag');
                m.off('click');
                
                m.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    selectedMarker = { marker: m, polygon, index: i, allMarkers };
                    highlightMarker(m);
                });
                
                m.on('drag', function(e) {
                    const newLatLng = e.target.getLatLng();
                    const currentLatlngs = polygon.getLatLngs()[0];
                    currentLatlngs[i] = newLatLng;
                    polygon.setLatLngs(currentLatlngs);
                    updateAreasList();
                    saveToStorage();
                });
            });
            
            selectedMarker = null;
            updateAreasList();
            saveToStorage();
        }
        
        function addArea(polygon, markers) {
            const id = 'area_' + Date.now();
            
            markers.forEach((marker, index) => {
                marker.off('drag');
                marker.off('click');
                
                marker.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    selectedMarker = { marker, polygon, index, allMarkers: markers };
                    highlightMarker(marker);
                });
                
                marker.on('drag', function(e) {
                    const newLatLng = e.target.getLatLng();
                    const currentLatlngs = polygon.getLatLngs()[0];
                    currentLatlngs[index] = newLatLng;
                    polygon.setLatLngs(currentLatlngs);
                    updateAreasList();
                    saveToStorage();
                });
            });
            
            const area = {
                id: id,
                polygon: polygon,
                markers: markers
            };
            areas.push(area);
            
            polygon.on('click', function(e) {
                if (currentDrawingMode === null) {
                    addPointToPolygon(polygon, e.latlng, markers);
                    selectArea(id);
                }
            });
            
            updateAreasList();
            saveToStorage();
        }
        
        function selectArea(id) {
            selectedArea = id;
            selectedHelper = null;
            
            areas.forEach(area => {
                if (area.id === id) {
                    area.polygon.setStyle({color: '#FF5722', weight: 3});
                } else {
                    area.polygon.setStyle({color: '#2E7D32', weight: 2});
                }
            });
            
            updateAreasList();
        }
        
        function deleteArea(id) {
            const index = areas.findIndex(a => a.id === id);
            if (index > -1) {
                map.removeLayer(areas[index].polygon);
                areas[index].markers.forEach(marker => map.removeLayer(marker));
                areas.splice(index, 1);
                selectedArea = null;
                updateAreasList();
                saveToStorage();
            }
        }
        
        function focusArea(id) {
            const area = areas.find(a => a.id === id);
            if (area) {
                map.fitBounds(area.polygon.getBounds());
                selectArea(id);
            }
        }
        
        function addHelperMarker(latlng) {
            const marker = L.marker(latlng, {
                draggable: true,
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"><circle cx="8" cy="8" r="7" fill="#FFC107" stroke="#FF9800" stroke-width="2"/></svg>'),
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                })
            }).addTo(map);
            
            const index = helperMarkers.length;
            helperMarkers.push({marker: marker, latlng: latlng});
            
            marker.on('click', function() {
                selectHelper(index);
            });
            
            marker.on('drag', function(e) {
                helperMarkers[index].latlng = e.target.getLatLng();
                updateHelpersList();
                saveToStorage();
            });
            
            updateHelpersList();
            saveToStorage();
        }
        
        function addHelperByCoords() {
            const lat = parseFloat(document.getElementById('helperLat').value);
            const lng = parseFloat(document.getElementById('helperLng').value);
            
            if (isNaN(lat) || isNaN(lng)) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØµØ­ÙŠØ­Ø©');
                return;
            }
            
            addHelperMarker(L.latLng(lat, lng));
            clearHelperForm();
            map.setView([lat, lng], 13);
        }
        
        function clearHelperForm() {
            document.getElementById('helperLat').value = '';
            document.getElementById('helperLng').value = '';
        }
        
        function selectHelper(index) {
            selectedHelper = index;
            selectedArea = null;
            updateHelpersList();
        }
        
        function deleteHelper(index) {
            if (index < 0 || index >= helperMarkers.length) return;
            
            map.removeLayer(helperMarkers[index].marker);
            helperMarkers.splice(index, 1);
            selectedHelper = null;
            updateHelpersList();
            saveToStorage();
        }
        
        function updateAreasList() {
            const list = document.getElementById('areasList');
            if (areas.length === 0) {
                list.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ù…Ø­Ø¯Ø¯Ø©<br>Ø§Ø³ØªØ®Ø¯Ù… "Ø±Ø³Ù… Ù…Ù†Ø·Ù‚Ø©" Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ø·Ù‚</div>';
                return;
            }
            
            list.innerHTML = areas.map((area, index) => {
                const coords = area.polygon.getLatLngs()[0];
                const coordsHtml = coords.map((c, i) => 
                    `<div>${i + 1}. ${c.lat.toFixed(6)}, ${c.lng.toFixed(6)}</div>`
                ).join('');
                
                const isSelected = area.id === selectedArea;
                
                return `
                    <div class="area-item ${isSelected ? 'selected' : ''}" onclick="selectArea('${area.id}')">
                        <div class="area-header">
                            <span class="area-title">Ù…Ù†Ø·Ù‚Ø© ${index + 1}</span>
                            <div class="area-actions">
                                <button onclick="event.stopPropagation(); focusArea('${area.id}')">ğŸ“</button>
                                <button class="danger" onclick="event.stopPropagation(); deleteArea('${area.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="coords">${coordsHtml}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updateHelpersList() {
            const list = document.getElementById('helpersList');
            if (helperMarkers.length === 0) {
                list.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· Ù…Ø³Ø§Ø¹Ø¯Ø©</div>';
                return;
            }
            
            list.innerHTML = helperMarkers.map((h, index) => {
                const isSelected = index === selectedHelper;
                return `
                    <div class="helper-item ${isSelected ? 'selected' : ''}" onclick="selectHelper(${index})">
                        <div class="helper-info">
                            <div>Ù†Ù‚Ø·Ø© ${index + 1}</div>
                            <div class="helper-coords">${h.latlng.lat.toFixed(6)}, ${h.latlng.lng.toFixed(6)}</div>
                        </div>
                        <button class="danger" onclick="event.stopPropagation(); deleteHelper(${index})">ğŸ—‘ï¸</button>
                    </div>
                `;
            }).join('');
        }
        
        async function handleShpUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const geojson = await shp(arrayBuffer);
                
                const id = 'shp_' + Date.now();
                const shpData = {
                    id: id,
                    name: file.name,
                    geojson: geojson,
                    color: '#9C27B0',
                    weight: 2,
                    opacity: 1
                };
                
                const layer = createShpLayer(shpData);
                shpData.layer = layer;
                
                shpLayers.push(shpData);
                
                map.fitBounds(layer.getBounds());
                updateShpList();
                event.target.value = '';
                
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù SHP: ' + error.message);
                console.error(error);
                event.target.value = '';
            }
        }
        
        function createShpLayer(shpData) {
            return L.geoJSON(shpData.geojson, {
                style: {
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    color: shpData.color,
                    weight: shpData.weight,
                    opacity: shpData.opacity,
                    dashArray: '5, 5'
                },
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: shpData.weight * 2,
                        fillColor: shpData.color,
                        color: shpData.color,
                        weight: 2,
                        opacity: shpData.opacity,
                        fillOpacity: 0.6
                    });
                }
            }).addTo(map);
        }
        
        function updateShpStyle(id) {
            const shp = shpLayers.find(s => s.id === id);
            if (!shp) return;
            
            map.removeLayer(shp.layer);
            shp.layer = createShpLayer(shp);
        }
        
        function deleteShpLayer(id) {
            const index = shpLayers.findIndex(s => s.id === id);
            if (index > -1) {
                map.removeLayer(shpLayers[index].layer);
                shpLayers.splice(index, 1);
                updateShpList();
            }
        }
        
        function focusShpLayer(id) {
            const shp = shpLayers.find(s => s.id === id);
            if (shp) {
                map.fitBounds(shp.layer.getBounds());
            }
        }
        
        function updateShpList() {
            const list = document.getElementById('shpList');
            if (shpLayers.length === 0) {
                list.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª SHP Ù…Ø­Ù…Ù„Ø©</div>';
                return;
            }
            
            list.innerHTML = shpLayers.map((shp, index) => {
                const featureCount = shp.geojson.features ? shp.geojson.features.length : 1;
                
                return `
                    <div class="shp-item">
                        <div class="shp-header">
                            <div class="shp-info">
                                <div class="shp-name">${shp.name}</div>
                                <div style="color: #666; font-size: 11px; margin-top: 3px;">
                                    ${featureCount} Ø¹Ù†ØµØ±
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="focusShpLayer('${shp.id}')" style="padding: 5px 10px; font-size: 12px;">ğŸ“</button>
                                <button class="danger" onclick="deleteShpLayer('${shp.id}')" style="padding: 5px 10px; font-size: 12px;">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="shp-controls">
                            <div class="shp-control-row">
                                <label>Ø§Ù„Ù„ÙˆÙ†:</label>
                                <input type="color" value="${shp.color}" onchange="changeShpColor('${shp.id}', this.value)">
                            </div>
                            <div class="shp-control-row">
                                <label>Ø§Ù„Ø³ÙÙ…Ùƒ:</label>
                                <input type="range" min="1" max="10" value="${shp.weight}" oninput="changeShpWeight('${shp.id}', this.value); this.nextElementSibling.value = this.value">
                                <input type="number" min="1" max="10" value="${shp.weight}" onchange="changeShpWeight('${shp.id}', this.value); this.previousElementSibling.value = this.value">
                            </div>
                            <div class="shp-control-row">
                                <label>Ø§Ù„Ø´ÙØ§ÙÙŠØ©:</label>
                                <input type="range" min="0" max="1" step="0.1" value="${shp.opacity}" oninput="changeShpOpacity('${shp.id}', this.value); this.nextElementSibling.value = this.value">
                                <input type="number" min="0" max="1" step="0.1" value="${shp.opacity}" onchange="changeShpOpacity('${shp.id}', this.value); this.previousElementSibling.value = this.value">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function changeShpColor(id, color) {
            const shp = shpLayers.find(s => s.id === id);
            if (shp) {
                shp.color = color;
                updateShpStyle(id);
            }
        }
        
        function changeShpWeight(id, weight) {
            const shp = shpLayers.find(s => s.id === id);
            if (shp) {
                shp.weight = parseFloat(weight);
                updateShpStyle(id);
            }
        }
        
        function changeShpOpacity(id, opacity) {
            const shp = shpLayers.find(s => s.id === id);
            if (shp) {
                shp.opacity = parseFloat(opacity);
                updateShpStyle(id);
            }
        }
        
        function saveGeoJSON() {
            if (areas.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø·Ù‚ Ù„Ù„Ø­ÙØ¸');
                return;
            }
            
            const features = areas.map(area => {
                const coords = area.polygon.getLatLngs()[0].map(c => [c.lng, c.lat]);
                coords.push(coords[0]);
                
                return {
                    type: 'Feature',
                    properties: {},
                    geometry: {
                        type: 'Polygon',
                        coordinates: [coords]
                    }
                };
            });
            
            const geojson = {
                type: 'FeatureCollection',
                features: features
            };
            
            const dataStr = JSON.stringify(geojson, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'map_data.geojson';
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function clearAll() {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙˆÙ†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©ØŸ')) return;
            
            areas.forEach(area => {
                map.removeLayer(area.polygon);
                area.markers.forEach(marker => map.removeLayer(marker));
            });
            areas = [];
            selectedArea = null;
            
            helperMarkers.forEach(h => map.removeLayer(h.marker));
            helperMarkers = [];
            selectedHelper = null;
            
            updateAreasList();
            updateHelpersList();
            saveToStorage();
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-panel').classList.add('active');
        }
        
        document.getElementById('drawPolygon').addEventListener('click', function() {
            stopDrawing();
            currentDrawingMode = 'polygon';
            this.classList.add('active');
        });
        
        document.getElementById('addHelper').addEventListener('click', function() {
            stopDrawing();
            currentDrawingMode = 'helper';
            this.classList.add('active');
        });
        
        document.getElementById('stopDrawing').addEventListener('click', stopDrawing);
        
        function stopDrawing() {
            if (currentDrawingMode === 'polygon' && tempMarkers.length >= 3) {
                finishPolygon();
            } else {
                tempMarkers.forEach(m => map.removeLayer(m.marker));
                if (drawingPolygon) map.removeLayer(drawingPolygon);
                tempMarkers = [];
                drawingPolygon = null;
            }
            
            currentDrawingMode = null;
            document.querySelectorAll('.drawing-tools button').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        window.addEventListener('load', initMap);
    </script>
</body>
</html>